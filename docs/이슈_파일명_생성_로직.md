# 이슈 파일명 생성 로직

> 작성일: 2026-02-27

---

## 기능 개요

AI 요약 결과를 Issue 파일로 저장할 때, 파일명을 자동으로 생성합니다.
YAML frontmatter 또는 마크다운 헤딩에서 제목을 추출하고, 다중 패턴으로
기존 이슈 번호를 파악하여 순번을 채번합니다.

---

## 파일명 형식

```
{폴더명}_{순번:03d}_{제목}.md
```

예시:
```
ACME_001_프로젝트_킥오프_회의록.md
영업팀_002_Q1_전략_보고.md
```

---

## 주요 변경 내용

### 기존 방식 (변경 전)

```
{CODE}-{순번:03d}_{제목}.md
```
- `CODE`: 기존 파일의 `-` 앞 부분 참조 (없으면 account 앞 4자)
- 순번: `name.split("-")[-1].split("_")[0]` 단일 패턴
- 제목: AI 출력 첫 줄만 참조

### 개선 방식 (변경 후)

#### 1. `_extract_issue_index(stem)` — 순번 추출

두 가지 파일명 패턴 모두 지원:

| 패턴 | 예시 | 정규식 |
|------|------|--------|
| 새 규칙 | `folder_001_title` | `^[^_]+_(\d+)_` |
| 기존 규칙 | `CODE-001_title` | `^[^-]+-(\d+)_` |

기존 파일의 최대 순번 + 1로 다음 번호 결정.

#### 2. `_extract_title_from_ai_output(ai_output, fallback)` — 제목 추출

우선순위 순으로 제목 탐색:

1. **YAML frontmatter의 `title:` 필드**
   ```yaml
   ---
   title: "Q1 전략 보고서"
   ---
   ```
2. **첫 번째 마크다운 헤딩** (`# 제목`)
3. **fallback**: 원본 파일명(stem)

#### 3. `_sanitize_filename_token(value, fallback)` — 파일명 정규화

- 특수문자 제거: `\ / : * ? " < > |`
- 연속 공백 → 단일 공백
- 공백 → 언더스코어(`_`)
- 연속 언더스코어 제거
- 최대 80자 제한

---

## 처리 흐름

```
AI 출력 수신
    ↓
account 폴더 결정
    ↓
Issues/ 폴더 내 기존 파일 스캔
    ↓
_extract_issue_index() → 다음 순번 계산
    ↓
_extract_title_from_ai_output() → 제목 추출
    ↓
_sanitize_filename_token() × 2 → 폴더명, 제목 정규화
    ↓
파일 저장: {폴더명}_{순번}_{제목}.md
```

---

## 관련 파일

| 파일 | 변경 내용 |
|------|-----------|
| `web/routers/ai.py` | `_extract_issue_index()`, `_extract_title_from_ai_output()`, `_sanitize_filename_token()` 함수 추가; `_save_ai_output()` 리팩터링 |
